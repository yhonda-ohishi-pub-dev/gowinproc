server:
  host: localhost
  port: 8080
  grpc_port: 50051

# Cloudflare Tunnel設定
tunnel:
  enabled: true
  port: 8080
  protocol: http2
  client_id: gowinproc
  worker_url: https://ohishi-auth.mtamaramu.com
  private_key_path: ./keys/client_private.pem
  require_auth: true  # Require Bearer token authentication for tunnel access

# db_service プロセス定義
processes:
  # db_service - Local環境
  - name: db_service_local
    repository: yhonda-ohishi-pub-dev/db_service
    max_instances: 3
    auto_restart: true
    env:
      DB_ENV: local
    secrets_keys:
      - DB_HOST
      - DB_PORT
      - DB_USER
      - DB_PASSWORD
      - DB_NAME
    health_check:
      enabled: true
      endpoint: /health
      interval: 30s
      timeout: 5s
      retries: 3

  # db_service - Prod環境
  - name: db_service_prod
    repository: yhonda-ohishi-pub-dev/db_service
    max_instances: 3
    auto_restart: true
    env:
      DB_ENV: prod
    secrets_keys:
      - PROD_DB_HOST
      - PROD_DB_PORT
      - PROD_DB_USER
      - PROD_DB_PASSWORD
      - PROD_DB_NAME
    health_check:
      enabled: true
      endpoint: /health
      interval: 30s
      timeout: 5s
      retries: 3

  # db_service - SQL Server環境
  - name: db_service_sqlserver
    repository: yhonda-ohishi-pub-dev/db_service
    port: 5021
    max_instances: 3
    auto_restart: true
    env:
      DB_ENV: sqlserver
    secrets_keys:
      - SQLSERVER_HOST
      - SQLSERVER_INSTANCE
      - SQLSERVER_USER
      - SQLSERVER_PASSWORD
      - SQLSERVER_DATABASE
    health_check:
      enabled: true
      endpoint: /health
      interval: 30s
      timeout: 5s
      retries: 3

  # etc_meisai_scraper - ETCスクレイピングサービス
  - name: etc_meisai_scraper
    repository: yhonda-ohishi-pub-dev/etc_meisai_scraper
    max_instances: 2
    auto_restart: true
    env:
      ETC_HEADLESS: "false"  # ブラウザ表示モード（README参照）
    health_check:
      enabled: false  # gRPCサーバーのためHTTPヘルスチェック無効

  # desktop-server - システムトレイアプリ（フロントエンド埋め込み）
  - name: desktop_server
    repository: yhonda-ohishi-pub-dev/desktop-server
    max_instances: 1
    auto_restart: true
    env:
      HTTP_PORT: "8081"  # gowinprocのポート8080と競合しないように別ポートを使用
    health_check:
      enabled: false  # HTTPヘルスチェック無効

# Cloudflareから環境変数（DB接続情報）を取得
secrets:
  mode: cloudflare
  override: true  # 起動時に常に.envファイルを再生成
  cloudflare:
    worker_url: https://ohishi-auth.mtamaramu.com
    private_key_path: ./keys/client_private.pem

github:
  mode: cloudflare
  update_mode:
    polling:
      enabled: true
      interval: 5m